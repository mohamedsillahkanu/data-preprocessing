<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Data Cleaning & Quality Assessment Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #f8f9ff, #e8edff);
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(45deg, #e8edff, #f8f9ff);
            transform: translateY(-2px);
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
        }

        .file-info {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
            border-radius: 10px;
            border-left: 4px solid #28a745;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 150px;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            color: white;
            font-weight: 600;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab.active {
            background: linear-gradient(135deg, #ffffff, #f8f9ff);
            color: #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        select, input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .data-table {
            overflow: auto;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-top: 20px;
            max-height: 400px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9ff;
        }

        .analysis-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .analysis-section h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .result-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .result-card h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff, #f8f9ff);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .uniqueness-list {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9ff;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .uniqueness-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 5px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .uniqueness-value {
            font-weight: 500;
        }

        .uniqueness-count {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
        }

        .similarity-section {
            margin-top: 20px;
        }

        .similarity-pair {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .similarity-values {
            display: flex;
            gap: 20px;
        }

        .similarity-score {
            font-weight: bold;
            color: #856404;
        }

        .replace-btn {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .error {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #333;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .type-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .type-card h5 {
            color: #333;
            margin-bottom: 10px;
        }

        .type-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .type-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .type-numeric {
            background: #d4edda;
            color: #155724;
        }

        .type-text {
            background: #cce5ff;
            color: #004085;
        }

        .type-date {
            background: #fff3cd;
            color: #856404;
        }

        .type-boolean {
            background: #f8d7da;
            color: #721c24;
        }

        .cleaning-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .cleaning-option {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }

        .cleaning-option h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .cleaning-option p {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .cleaning-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üßπ Advanced Data Cleaning & Quality Assessment Tool</h1>
            <p>Upload your data files and perform comprehensive data quality analysis and cleaning operations</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <h3>Drop your Excel or CSV file here or click to browse</h3>
                <p>Supports .xlsx, .xls, .csv files up to 50MB</p>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    Choose File
                </button>
            </div>
            <div id="fileInfo" class="file-info" style="display: none;"></div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('overview')">üìã Overview</div>
            <div class="tab" onclick="switchTab('uniqueness')">üîç Data Uniqueness</div>
            <div class="tab" onclick="switchTab('types')">üìä Data Types</div>
            <div class="tab" onclick="switchTab('validation')">‚úÖ Value Validation</div>
            <div class="tab" onclick="switchTab('cleaning')">üßπ Data Cleaning</div>
            <div class="tab" onclick="switchTab('export')">üíæ Export</div>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <h2>üìã Data Overview</h2>
            <div class="controls">
                <div class="control-group">
                    <label for="overviewSheet">Select Sheet:</label>
                    <select id="overviewSheet" onchange="updateOverview()"></select>
                </div>
            </div>
            <div id="overviewStats" class="stats-grid"></div>
            <div id="dataPreview"></div>
        </div>

        <!-- Data Uniqueness Tab -->
        <div id="uniqueness" class="tab-content">
            <h2>üîç Data Uniqueness Analysis</h2>
            <div class="controls">
                <div class="control-group">
                    <label for="uniquenessSheet">Select Sheet:</label>
                    <select id="uniquenessSheet" onchange="updateUniquenessColumns()"></select>
                </div>
                <div class="control-group">
                    <label for="uniquenessColumn">Select Categorical Column:</label>
                    <select id="uniquenessColumn"></select>
                </div>
                <div class="control-group">
                    <label for="similarityThreshold">Similarity Threshold (0-1):</label>
                    <input type="number" id="similarityThreshold" value="0.8" min="0" max="1" step="0.05">
                </div>
                <div class="control-group" style="display: flex; align-items: end; gap: 10px;">
                    <button class="btn" onclick="analyzeUniqueness()">üîç Analyze Uniqueness</button>
                    <button class="btn btn-secondary" onclick="checkSimilarity()">üìù Check Similarity</button>
                </div>
            </div>
            <div id="uniquenessResults"></div>
        </div>

        <!-- Data Types Tab -->
        <div id="types" class="tab-content">
            <h2>üìä Data Type Analysis & Conversion</h2>
            <div class="controls">
                <div class="control-group">
                    <label for="typesSheet">Select Sheet:</label>
                    <select id="typesSheet" onchange="analyzeDataTypes()"></select>
                </div>
                <div class="control-group" style="display: flex; align-items: end;">
                    <button class="btn" onclick="analyzeDataTypes()">üß¨ Analyze Data Types</button>
                </div>
            </div>
            <div id="dataTypesResults"></div>
        </div>

        <!-- Value Validation Tab -->
        <div id="validation" class="tab-content">
            <h2>‚úÖ Numeric Value Validation</h2>
            <div class="controls">
                <div class="control-group">
                    <label for="validationSheet">Select Sheet:</label>
                    <select id="validationSheet" onchange="updateValidationColumns()"></select>
                </div>
                <div class="control-group">
                    <label for="validationColumn">Select Numeric Column:</label>
                    <select id="validationColumn"></select>
                </div>
                <div class="control-group" style="display: flex; align-items: end; gap: 10px;">
                    <button class="btn" onclick="validateNumericValues()">‚úÖ Validate Values</button>
                    <button class="btn btn-success" onclick="convertToNumeric()">üî¢ Convert to Numeric</button>
                </div>
            </div>
            <div id="validationResults"></div>
        </div>

        <!-- Data Cleaning Tab -->
        <div id="cleaning" class="tab-content">
            <h2>üßπ Data Cleaning Operations</h2>
            <div class="controls">
                <div class="control-group">
                    <label for="cleaningSheet">Select Sheet:</label>
                    <select id="cleaningSheet"></select>
                </div>
                <div class="control-group" style="display: flex; align-items: end;">
                    <button class="btn btn-success" onclick="downloadCleanedData()">üíæ Download Cleaned Data</button>
                </div>
            </div>

            <div class="cleaning-options">
                <div class="cleaning-option">
                    <h4>üî§ Remove Leading/Trailing Spaces</h4>
                    <p>Clean all text cells by removing unnecessary spaces</p>
                    <button class="btn" onclick="trimSpaces()">Clean Spaces</button>
                </div>

                <div class="cleaning-option">
                    <h4>üî£ Remove Accents</h4>
                    <p>Convert accented characters to regular ASCII</p>
                    <button class="btn" onclick="removeAccents()">Remove Accents</button>
                </div>

                <div class="cleaning-option">
                    <h4>üìã Remove Unnamed Columns</h4>
                    <p>Delete columns without proper headers</p>
                    <button class="btn" onclick="removeUnnamedColumns()">Remove Columns</button>
                </div>

                <div class="cleaning-option">
                    <h4>üö´ Remove Special Characters</h4>
                    <p>Remove .?/ characters from all cells</p>
                    <button class="btn" onclick="removeSpecialCharacters()">Clean Characters</button>
                </div>
            </div>

            <div id="cleaningResults"></div>
        </div>

        <!-- Export Tab -->
        <div id="export" class="tab-content">
            <h2>üíæ Export Cleaned Data</h2>
            <div class="controls">
                <div class="control-group">
                    <label for="exportSheet">Select Sheet:</label>
                    <select id="exportSheet"></select>
                </div>
                <div class="control-group">
                    <label for="exportFormat">Export Format:</label>
                    <select id="exportFormat">
                        <option value="excel">Excel (.xlsx)</option>
                        <option value="csv">CSV (.csv)</option>
                        <option value="json">JSON (.json)</option>
                    </select>
                </div>
                <div class="control-group" style="display: flex; align-items: end;">
                    <button class="btn" onclick="exportData()">üì• Download</button>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>üìÑ Total Sheets</h4>
                    <div class="stat-value" id="totalSheets">0</div>
                </div>
                <div class="stat-card">
                    <h4>üìä Total Rows</h4>
                    <div class="stat-value" id="totalRows">0</div>
                </div>
                <div class="stat-card">
                    <h4>üìã Total Columns</h4>
                    <div class="stat-value" id="totalColumns">0</div>
                </div>
                <div class="stat-card">
                    <h4>üíæ File Size</h4>
                    <div class="stat-value" id="fileSize">0 KB</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let workbookData = {};
        let processedData = {};

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');

        // Initialize drag and drop functionality
        function initializeFileUpload() {
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#28a745';
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#667eea';
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#667eea';
                const files = e.dataTransfer.files;
                handleFiles(files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            if (files.length === 0) return;

            const file = files[0];
            if (!file.name.match(/\.(xlsx|xls|csv)$/)) {
                showError('Please select a valid Excel (.xlsx, .xls) or CSV (.csv) file');
                return;
            }

            if (file.size > 50 * 1024 * 1024) {
                showError('File size must be less than 50MB');
                return;
            }

            // Check if it's a CSV file
            if (file.name.toLowerCase().endsWith('.csv')) {
                processCSVFile(file);
            } else {
                processExcelFile(file);
            }
        }

        function processCSVFile(file) {
            fileInfo.innerHTML = '<div class="info">Processing CSV file...</div>';
            fileInfo.style.display = 'block';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    
                    Papa.parse(csvText, {
                        header: false,
                        skipEmptyLines: true,
                        dynamicTyping: false, // Keep as strings for better control
                        complete: function(results) {
                            try {
                                if (results.errors.length > 0) {
                                    console.warn('CSV parsing warnings:', results.errors);
                                }

                                const data = results.data;
                                if (data.length === 0) {
                                    showError('CSV file appears to be empty');
                                    return;
                                }

                                // Use filename without extension as sheet name
                                const sheetName = file.name.replace(/\.csv$/i, '');
                                workbookData = {};
                                processedData = {};
                                workbookData[sheetName] = data;
                                processedData[sheetName] = JSON.parse(JSON.stringify(data));

                                const totalRows = data.length;
                                const totalColumns = data.length > 0 ? Math.max(...data.map(row => row.length)) : 0;

                                fileInfo.innerHTML = `
                                    <div class="success">
                                        <strong>‚úÖ CSV file loaded successfully!</strong><br>
                                        üìÅ ${file.name} (${formatFileSize(file.size)})<br>
                                        üìÑ 1 sheet, ${totalRows} rows, ${totalColumns} columns
                                    </div>
                                `;

                                populateSheetDropdowns();
                                updateOverview();
                            } catch (error) {
                                showError('Error processing CSV data: ' + error.message);
                            }
                        },
                        error: function(error) {
                            showError('Error parsing CSV file: ' + error.message);
                        }
                    });
                } catch (error) {
                    showError('Error reading CSV file: ' + error.message);
                }
            };

            reader.onerror = function() {
                showError('Error reading the file');
            };

            reader.readAsText(file);
        }

        function processExcelFile(file) {
            const reader = new FileReader();
            
            fileInfo.innerHTML = '<div class="info">Processing Excel file...</div>';
            fileInfo.style.display = 'block';

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    workbookData = {};
                    processedData = {};
                    let totalRows = 0;
                    let totalColumns = 0;

                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                        
                        const filteredData = jsonData.filter(row => row.some(cell => cell !== undefined && cell !== ''));
                        
                        if (filteredData.length > 0) {
                            workbookData[sheetName] = filteredData;
                            processedData[sheetName] = JSON.parse(JSON.stringify(filteredData));
                            totalRows += filteredData.length;
                            totalColumns = Math.max(totalColumns, Math.max(...filteredData.map(row => row.length)));
                        }
                    });

                    fileInfo.innerHTML = `
                        <div class="success">
                            <strong>‚úÖ Excel file loaded successfully!</strong><br>
                            üìÅ ${file.name} (${formatFileSize(file.size)})<br>
                            üìÑ ${Object.keys(workbookData).length} sheets, ${totalRows} rows, ${totalColumns} columns
                        </div>
                    `;

                    // Update export stats
                    document.getElementById('totalSheets').textContent = Object.keys(workbookData).length;
                    document.getElementById('totalRows').textContent = totalRows.toLocaleString();
                    document.getElementById('totalColumns').textContent = totalColumns;
                    document.getElementById('fileSize').textContent = formatFileSize(file.size);

                    populateSheetDropdowns();
                    updateOverview();
                    
                } catch (error) {
                    showError('Error processing file: ' + error.message);
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function populateSheetDropdowns() {
            const sheetNames = Object.keys(workbookData);
            const dropdowns = ['overviewSheet', 'uniquenessSheet', 'typesSheet', 'validationSheet', 'cleaningSheet', 'exportSheet'];
            
            dropdowns.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '';
                    sheetNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        select.appendChild(option);
                    });
                }
            });

            if (sheetNames.length > 0) {
                updateUniquenessColumns();
                updateValidationColumns();
            }
        }

        function updateOverview() {
            const sheetName = document.getElementById('overviewSheet').value;
            if (!sheetName || !workbookData[sheetName]) return;

            const data = workbookData[sheetName];
            const headers = data[0] || [];
            const rows = data.slice(1);

            // Update stats
            const statsHtml = `
                <div class="stat-card">
                    <h4>üìä Total Rows</h4>
                    <div class="stat-value">${rows.length.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <h4>üìã Total Columns</h4>
                    <div class="stat-value">${headers.length}</div>
                </div>
                <div class="stat-card">
                    <h4>üìù Text Columns</h4>
                    <div class="stat-value">${countColumnsByType(data, 'text')}</div>
                </div>
                <div class="stat-card">
                    <h4>üî¢ Numeric Columns</h4>
                    <div class="stat-value">${countColumnsByType(data, 'numeric')}</div>
                </div>
            `;
            document.getElementById('overviewStats').innerHTML = statsHtml;

            // Show data preview
            showDataPreview(data, sheetName);
        }

        function showDataPreview(data, sheetName) {
            const maxRows = Math.min(data.length, 11); // Header + 10 rows
            
            let html = `
                <div class="result-card">
                    <h4>üìÑ ${sheetName} - Data Preview</h4>
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
            `;
            
            // Headers
            if (data.length > 0) {
                const maxCols = Math.min(data[0].length, 10);
                for (let i = 0; i < maxCols; i++) {
                    html += `<th>${data[0][i] || `Column ${i+1}`}</th>`;
                }
                if (data[0].length > 10) {
                    html += '<th>...</th>';
                }
            }
            
            html += `
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Data rows
            for (let i = 1; i < maxRows; i++) {
                if (data[i]) {
                    html += '<tr>';
                    const maxCols = Math.min(data[i].length, 10);
                    for (let j = 0; j < maxCols; j++) {
                        html += `<td>${data[i][j] || ''}</td>`;
                    }
                    if (data[i].length > 10) {
                        html += '<td>...</td>';
                    }
                    html += '</tr>';
                }
            }
            
            if (data.length > 11) {
                html += '<tr><td colspan="100%" style="text-align: center; font-style: italic;">... and more rows</td></tr>';
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('dataPreview').innerHTML = html;
        }

        function countColumnsByType(data, type) {
            if (data.length < 2) return 0;
            
            const headers = data[0];
            const rows = data.slice(1);
            let count = 0;

            headers.forEach((header, index) => {
                const columnData = rows.map(row => row[index]).filter(val => val !== undefined && val !== '');
                if (columnData.length > 0) {
                    const analysis = analyzeDataType(columnData);
                    if ((type === 'numeric' && analysis.type === 'Numeric') || 
                        (type === 'text' && analysis.type === 'Text')) {
                        count++;
                    }
                }
            });

            return count;
        }

        // Data Uniqueness Functions
        function updateUniquenessColumns() {
            const sheetName = document.getElementById('uniquenessSheet').value;
            if (!sheetName || !workbookData[sheetName]) return;

            const headers = workbookData[sheetName][0] || [];
            const select = document.getElementById('uniquenessColumn');
            
            select.innerHTML = '';
            headers.forEach(header => {
                const option = document.createElement('option');
                option.value = header;
                option.textContent = header;
                select.appendChild(option);
            });
        }

        function analyzeUniqueness() {
            const sheetName = document.getElementById('uniquenessSheet').value;
            const columnName = document.getElementById('uniquenessColumn').value;
            
            if (!sheetName || !columnName) {
                showError('Please select sheet and column');
                return;
            }

            const data = processedData[sheetName] || workbookData[sheetName];
            const headers = data[0];
            const columnIndex = headers.indexOf(columnName);
            
            if (columnIndex === -1) {
                showError('Column not found');
                return;
            }

            const values = data.slice(1)
                .map(row => row[columnIndex])
                .filter(val => val !== undefined && val !== '')
                .map(val => String(val));

            const uniqueValues = [...new Set(values)].sort();
            const valueCounts = {};
            
            values.forEach(value => {
                valueCounts[value] = (valueCounts[value] || 0) + 1;
            });

            let html = `
                <div class="result-card">
                    <h4>üîç Uniqueness Analysis for "${columnName}"</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>üìä Total Values</h4>
                            <div class="stat-value">${values.length}</div>
                        </div>
                        <div class="stat-card">
                            <h4>‚ú® Unique Values</h4>
                            <div class="stat-value">${uniqueValues.length}</div>
                        </div>
                        <div class="stat-card">
                            <h4>üîÑ Duplicates</h4>
                            <div class="stat-value">${values.length - uniqueValues.length}</div>
                        </div>
                        <div class="stat-card">
                            <h4>üìä Uniqueness %</h4>
                            <div class="stat-value">${((uniqueValues.length / values.length) * 100).toFixed(1)}%</div>
                        </div>
                    </div>
                    
                    <h5>üìã All Unique Values (Alphabetical Order)</h5>
                    <div class="uniqueness-list">
            `;
            
            uniqueValues.forEach(value => {
                const count = valueCounts[value];
                const isDuplicate = count > 1;
                html += `
                    <div class="uniqueness-item" style="${isDuplicate ? 'border-left: 4px solid #ffc107;' : ''}">
                        <span class="uniqueness-value">${value}</span>
                        <span class="uniqueness-count ${isDuplicate ? 'btn-warning' : ''}">${count}</span>
                    </div>
                `;
            });
            
            html += '</div></div>';
            
            document.getElementById('uniquenessResults').innerHTML = html;
        }

        function checkSimilarity() {
            const sheetName = document.getElementById('uniquenessSheet').value;
            const columnName = document.getElementById('uniquenessColumn').value;
            const threshold = parseFloat(document.getElementById('similarityThreshold').value);
            
            if (!sheetName || !columnName) {
                showError('Please select sheet and column');
                return;
            }

            const data = processedData[sheetName] || workbookData[sheetName];
            const headers = data[0];
            const columnIndex = headers.indexOf(columnName);
            
            if (columnIndex === -1) {
                showError('Column not found');
                return;
            }

            const values = [...new Set(data.slice(1)
                .map(row => row[columnIndex])
                .filter(val => val !== undefined && val !== '')
                .map(val => String(val)))];

            const similarPairs = [];
            
            for (let i = 0; i < values.length; i++) {
                for (let j = i + 1; j < values.length; j++) {
                    const similarity = calculateSimilarity(values[i], values[j]);
                    if (similarity >= threshold && similarity < 1) {
                        similarPairs.push({
                            value1: values[i],
                            value2: values[j],
                            similarity: similarity
                        });
                    }
                }
            }

            let html = `
                <div class="result-card">
                    <h4>üìù Similarity Analysis for "${columnName}"</h4>
                    <p><strong>Threshold:</strong> ${threshold} | <strong>Similar Pairs Found:</strong> ${similarPairs.length}</p>
            `;

            if (similarPairs.length > 0) {
                html += `
                    <div class="similarity-section">
                        <h5>‚ö†Ô∏è Potentially Similar Values</h5>
                        <p style="color: #856404; margin-bottom: 15px;">
                            These values might be misspelled or duplicated. Review for potential data cleaning.
                        </p>
                `;
                
                similarPairs.forEach((pair, index) => {
                    html += `
                        <div class="similarity-pair">
                            <div class="similarity-values">
                                <span><strong>Value 1:</strong> "${pair.value1}"</span>
                                <span><strong>Value 2:</strong> "${pair.value2}"</span>
                                <span class="similarity-score">Similarity: ${(pair.similarity * 100).toFixed(1)}%</span>
                            </div>
                            <button class="btn btn-secondary replace-btn" 
                                    onclick="replaceSimilarValue('${columnName}', '${pair.value1}', '${pair.value2}')">
                                Replace "${pair.value1}" ‚Üí "${pair.value2}"
                            </button>
                        </div>
                    `;
                });
                
                html += '</div>';
            } else {
                html += '<div class="success">‚úÖ No similar values found above the threshold.</div>';
            }

            html += '</div>';
            
            document.getElementById('uniquenessResults').innerHTML = html;
        }

        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        function replaceSimilarValue(columnName, oldValue, newValue) {
            const sheetName = document.getElementById('uniquenessSheet').value;
            if (!processedData[sheetName]) return;

            const data = processedData[sheetName];
            const headers = data[0];
            const columnIndex = headers.indexOf(columnName);

            if (columnIndex === -1) return;

            let replaceCount = 0;
            for (let i = 1; i < data.length; i++) {
                if (String(data[i][columnIndex]) === String(oldValue)) {
                    data[i][columnIndex] = newValue;
                    replaceCount++;
                }
            }

            showMessage(`Replaced ${replaceCount} instances of "${oldValue}" with "${newValue}"`, 'success');
            
            // Refresh the similarity analysis
            setTimeout(() => {
                checkSimilarity();
            }, 1000);
        }

        // Data Types Analysis
        function analyzeDataTypes() {
            const sheetName = document.getElementById('typesSheet').value;
            if (!sheetName) return;

            const data = processedData[sheetName] || workbookData[sheetName];
            if (!data || data.length < 2) return;

            const headers = data[0];
            const rows = data.slice(1);

            let html = `
                <div class="result-card">
                    <h4>üìä Data Type Analysis for "${sheetName}"</h4>
                    <p>Analysis of data types for each column with conversion recommendations.</p>
                    <div style="margin-top: 20px;">
            `;

            headers.forEach((header, index) => {
                const columnData = rows.map(row => row[index]).filter(val => val !== undefined && val !== '');
                const analysis = analyzeDataType(columnData);
                
                html += `
                    <div class="type-card">
                        <h5>${header}</h5>
                        <div class="type-info">
                            <span>Detected Type: <span class="type-badge type-${analysis.type.toLowerCase()}">${analysis.type}</span></span>
                            <span>Confidence: <strong>${analysis.confidence}%</strong></span>
                        </div>
                        <div class="type-info">
                            <span>Sample Values: ${columnData.slice(0, 3).map(v => `"${v}"`).join(', ')}</span>
                            <span>Total Values: <strong>${columnData.length}</strong></span>
                        </div>
                        ${analysis.issues.length > 0 ? 
                            `<div style="margin-top: 10px;">
                                <strong>Issues Found:</strong>
                                <ul style="margin-left: 20px; margin-top: 5px;">
                                    ${analysis.issues.map(issue => `<li>${issue}</li>`).join('')}
                                </ul>
                            </div>` : ''
                        }
                        ${analysis.convertible ? 
                            `<button class="btn btn-success" style="margin-top: 10px;" 
                                     onclick="convertColumnType('${header}', '${analysis.recommendedType}')">
                                Convert to ${analysis.recommendedType}
                            </button>` : ''
                        }
                    </div>
                `;
            });

            html += '</div></div>';
            document.getElementById('dataTypesResults').innerHTML = html;
        }

        function analyzeDataType(columnData) {
            if (columnData.length === 0) {
                return { type: 'Empty', confidence: 100, issues: [], convertible: false };
            }

            let numCount = 0;
            let dateCount = 0;
            let boolCount = 0;
            let issues = [];

            columnData.forEach(val => {
                const strVal = String(val).trim();
                
                // Check if numeric
                if (!isNaN(strVal) && strVal !== '') {
                    numCount++;
                } else if (isNaN(strVal) && /^[\d,\s.]+$/.test(strVal)) {
                    numCount++;
                    issues.push('Numbers with formatting (commas, spaces)');
                }
                
                // Check if date
                if (isValidDate(strVal)) {
                    dateCount++;
                }
                
                // Check if boolean
                if (['true', 'false', 'yes', 'no', '1', '0'].includes(strVal.toLowerCase())) {
                    boolCount++;
                }
            });

            const total = columnData.length;
            const numPercent = (numCount / total) * 100;
            const datePercent = (dateCount / total) * 100;
            const boolPercent = (boolCount / total) * 100;

            let type, confidence, recommendedType, convertible = false;

            if (numPercent >= 80) {
                type = 'Numeric';
                confidence = Math.round(numPercent);
                if (numPercent < 100) {
                    recommendedType = 'Number';
                    convertible = true;
                }
            } else if (datePercent >= 80) {
                type = 'Date';
                confidence = Math.round(datePercent);
                recommendedType = 'Date';
                convertible = true;
            } else if (boolPercent >= 80) {
                type = 'Boolean';
                confidence = Math.round(boolPercent);
                recommendedType = 'Boolean';
                convertible = true;
            } else {
                type = 'Text';
                confidence = Math.round(Math.max(100 - numPercent - datePercent - boolPercent, 0));
            }

            return { type, confidence, issues: [...new Set(issues)], convertible, recommendedType };
        }

        function isValidDate(dateString) {
            const date = new Date(dateString);
            return date instanceof Date && !isNaN(date);
        }

        function convertColumnType(columnName, targetType) {
            const sheetName = document.getElementById('typesSheet').value;
            if (!processedData[sheetName]) {
                processedData[sheetName] = JSON.parse(JSON.stringify(workbookData[sheetName]));
            }

            const data = processedData[sheetName];
            const headers = data[0];
            const columnIndex = headers.indexOf(columnName);

            if (columnIndex === -1) {
                showError('Column not found');
                return;
            }

            let convertCount = 0;
            let errorCount = 0;

            for (let i = 1; i < data.length; i++) {
                const originalValue = data[i][columnIndex];
                if (originalValue !== undefined && originalValue !== '') {
                    try {
                        let convertedValue;
                        
                        switch (targetType) {
                            case 'Number':
                                convertedValue = parseFloat(String(originalValue).replace(/[,\s]/g, ''));
                                if (!isNaN(convertedValue)) {
                                    data[i][columnIndex] = convertedValue;
                                    convertCount++;
                                } else {
                                    errorCount++;
                                }
                                break;
                            case 'Date':
                                convertedValue = new Date(originalValue);
                                if (!isNaN(convertedValue)) {
                                    data[i][columnIndex] = convertedValue.toISOString().split('T')[0];
                                    convertCount++;
                                } else {
                                    errorCount++;
                                }
                                break;
                            case 'Boolean':
                                const lowerVal = String(originalValue).toLowerCase();
                                if (['true', 'yes', '1'].includes(lowerVal)) {
                                    data[i][columnIndex] = true;
                                    convertCount++;
                                } else if (['false', 'no', '0'].includes(lowerVal)) {
                                    data[i][columnIndex] = false;
                                    convertCount++;
                                } else {
                                    errorCount++;
                                }
                                break;
                        }
                    } catch (e) {
                        errorCount++;
                    }
                }
            }

            showMessage(`Converted ${convertCount} values to ${targetType}. ${errorCount} errors encountered.`, 'success');
            
            // Refresh the analysis
            setTimeout(() => {
                analyzeDataTypes();
            }, 1000);
        }

        // Value Validation Functions
        function updateValidationColumns() {
            const sheetName = document.getElementById('validationSheet').value;
            if (!sheetName || !workbookData[sheetName]) return;

            const headers = workbookData[sheetName][0] || [];
            const select = document.getElementById('validationColumn');
            
            select.innerHTML = '';
            headers.forEach(header => {
                const option = document.createElement('option');
                option.value = header;
                option.textContent = header;
                select.appendChild(option);
            });
        }

        function validateNumericValues() {
            const sheetName = document.getElementById('validationSheet').value;
            const columnName = document.getElementById('validationColumn').value;
            
            if (!sheetName || !columnName) {
                showError('Please select sheet and column');
                return;
            }

            const data = processedData[sheetName] || workbookData[sheetName];
            const headers = data[0];
            const columnIndex = headers.indexOf(columnName);
            
            if (columnIndex === -1) {
                showError('Column not found');
                return;
            }

            const values = data.slice(1).map((row, index) => ({
                value: row[columnIndex],
                rowIndex: index + 1
            })).filter(item => item.value !== undefined && item.value !== '');

            let numericCount = 0;
            let textNumericCount = 0;
            let nonNumericCount = 0;
            let issues = [];

            values.forEach(item => {
                const val = item.value;
                const strVal = String(val).trim();
                
                if (typeof val === 'number' && !isNaN(val)) {
                    numericCount++;
                } else if (typeof val === 'string' && !isNaN(parseFloat(strVal.replace(/[,\s]/g, '')))) {
                    textNumericCount++;
                    issues.push({
                        row: item.rowIndex,
                        value: val,
                        issue: 'Stored as text',
                        suggestion: parseFloat(strVal.replace(/[,\s]/g, ''))
                    });
                } else {
                    nonNumericCount++;
                    issues.push({
                        row: item.rowIndex,
                        value: val,
                        issue: 'Non-numeric value',
                        suggestion: 'Remove or convert'
                    });
                }
            });

            let html = `
                <div class="result-card">
                    <h4>‚úÖ Numeric Validation for "${columnName}"</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>‚úÖ Proper Numeric</h4>
                            <div class="stat-value">${numericCount}</div>
                        </div>
                        <div class="stat-card">
                            <h4>‚ö†Ô∏è Text Numbers</h4>
                            <div class="stat-value">${textNumericCount}</div>
                        </div>
                        <div class="stat-card">
                            <h4>‚ùå Non-Numeric</h4>
                            <div class="stat-value">${nonNumericCount}</div>
                        </div>
                        <div class="stat-card">
                            <h4>üìä Valid %</h4>
                            <div class="stat-value">${(((numericCount + textNumericCount) / values.length) * 100).toFixed(1)}%</div>
                        </div>
                    </div>
            `;

            if (issues.length > 0) {
                html += `
                    <h5>‚ö†Ô∏è Issues Found (showing first 20)</h5>
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Row</th>
                                    <th>Current Value</th>
                                    <th>Issue</th>
                                    <th>Suggestion</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                issues.slice(0, 20).forEach(issue => {
                    html += `
                        <tr>
                            <td>${issue.row}</td>
                            <td>"${issue.value}"</td>
                            <td>${issue.issue}</td>
                            <td>${issue.suggestion}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                
                if (textNumericCount > 0) {
                    html += `
                        <div style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="convertToNumeric()">
                                üî¢ Convert ${textNumericCount} text numbers to numeric
                            </button>
                        </div>
                    `;
                }
            } else {
                html += '<div class="success">‚úÖ All values in this column are properly numeric!</div>';
            }

            html += '</div>';
            
            document.getElementById('validationResults').innerHTML = html;
        }

        function convertToNumeric() {
            const sheetName = document.getElementById('validationSheet').value;
            const columnName = document.getElementById('validationColumn').value;
            
            if (!sheetName || !columnName) return;

            if (!processedData[sheetName]) {
                processedData[sheetName] = JSON.parse(JSON.stringify(workbookData[sheetName]));
            }

            const data = processedData[sheetName];
            const headers = data[0];
            const columnIndex = headers.indexOf(columnName);

            if (columnIndex === -1) return;

            let convertCount = 0;

            for (let i = 1; i < data.length; i++) {
                const val = data[i][columnIndex];
                if (typeof val === 'string' && val.trim() !== '') {
                    const numericVal = parseFloat(val.replace(/[,\s]/g, ''));
                    if (!isNaN(numericVal)) {
                        data[i][columnIndex] = numericVal;
                        convertCount++;
                    }
                }
            }

            showMessage(`Converted ${convertCount} text values to numeric`, 'success');
            
            // Refresh validation
            setTimeout(() => {
                validateNumericValues();
            }, 1000);
        }

        // Data Cleaning Functions
        function trimSpaces() {
            const sheetName = document.getElementById('cleaningSheet').value;
            if (!sheetName) {
                showError('Please select a sheet');
                return;
            }

            if (!processedData[sheetName]) {
                processedData[sheetName] = JSON.parse(JSON.stringify(workbookData[sheetName]));
            }

            const data = processedData[sheetName];
            let changeCount = 0;

            for (let i = 0; i < data.length; i++) {
                for (let j = 0; j < data[i].length; j++) {
                    if (typeof data[i][j] === 'string') {
                        const trimmed = data[i][j].trim();
                        if (trimmed !== data[i][j]) {
                            data[i][j] = trimmed;
                            changeCount++;
                        }
                    }
                }
            }

            showMessage(`Trimmed spaces from ${changeCount} cells`, 'success');
            updateCleaningResults();
        }

        function removeAccents() {
            const sheetName = document.getElementById('cleaningSheet').value;
            if (!sheetName) {
                showError('Please select a sheet');
                return;
            }

            if (!processedData[sheetName]) {
                processedData[sheetName] = JSON.parse(JSON.stringify(workbookData[sheetName]));
            }

            const data = processedData[sheetName];
            let changeCount = 0;

            const accentMap = {
                '√†': 'a', '√°': 'a', '√¢': 'a', '√£': 'a', '√§': 'a', '√•': 'a', '√¶': 'ae',
                '√®': 'e', '√©': 'e', '√™': 'e', '√´': 'e',
                '√¨': 'i', '√≠': 'i', '√Æ': 'i', '√Ø': 'i',
                '√≤': 'o', '√≥': 'o', '√¥': 'o', '√µ': 'o', '√∂': 'o', '√∏': 'o',
                '√π': 'u', '√∫': 'u', '√ª': 'u', '√º': 'u',
                '√Ω': 'y', '√ø': 'y', '√ß': 'c', '√±': 'n',
                '√Ä': 'A', '√Å': 'A', '√Ç': 'A', '√É': 'A', '√Ñ': 'A', '√Ö': 'A', '√Ü': 'AE',
                '√à': 'E', '√â': 'E', '√ä': 'E', '√ã': 'E',
                '√å': 'I', '√ç': 'I', '√é': 'I', '√è': 'I',
                '√í': 'O', '√ì': 'O', '√î': 'O', '√ï': 'O', '√ñ': 'O', '√ò': 'O',
                '√ô': 'U', '√ö': 'U', '√õ': 'U', '√ú': 'U',
                '√ù': 'Y', '≈∏': 'Y', '√á': 'C', '√ë': 'N'
            };

            for (let i = 0; i < data.length; i++) {
                for (let j = 0; j < data[i].length; j++) {
                    if (typeof data[i][j] === 'string') {
                        let original = data[i][j];
                        let cleaned = original.split('').map(char => accentMap[char] || char).join('');
                        
                        if (cleaned !== original) {
                            data[i][j] = cleaned;
                            changeCount++;
                        }
                    }
                }
            }

            showMessage(`Removed accents from ${changeCount} cells`, 'success');
            updateCleaningResults();
        }

        function removeUnnamedColumns() {
            const sheetName = document.getElementById('cleaningSheet').value;
            if (!sheetName) {
                showError('Please select a sheet');
                return;
            }

            if (!processedData[sheetName]) {
                processedData[sheetName] = JSON.parse(JSON.stringify(workbookData[sheetName]));
            }

            const data = processedData[sheetName];
            const headers = data[0];
            const indicesToRemove = [];

            // Find unnamed columns
            headers.forEach((header, index) => {
                if (!header || 
                    header.toString().includes('Unnamed') || 
                    header.toString().includes('Column') || 
                    header.toString().trim() === '' ||
                    header.toString().startsWith('__EMPTY')) {
                    indicesToRemove.push(index);
                }
            });

            // Remove columns from end to start to maintain indices
            indicesToRemove.reverse().forEach(index => {
                for (let i = 0; i < data.length; i++) {
                    data[i].splice(index, 1);
                }
            });

            showMessage(`Removed ${indicesToRemove.length} unnamed columns`, 'success');
            updateCleaningResults();
        }

        function removeSpecialCharacters() {
            const sheetName = document.getElementById('cleaningSheet').value;
            if (!sheetName) {
                showError('Please select a sheet');
                return;
            }

            if (!processedData[sheetName]) {
                processedData[sheetName] = JSON.parse(JSON.stringify(workbookData[sheetName]));
            }

            const data = processedData[sheetName];
            let changeCount = 0;

            for (let i = 0; i < data.length; i++) {
                for (let j = 0; j < data[i].length; j++) {
                    if (typeof data[i][j] === 'string') {
                        const cleaned = data[i][j].replace(/[.?/]/g, '');
                        if (cleaned !== data[i][j]) {
                            data[i][j] = cleaned;
                            changeCount++;
                        }
                    }
                }
            }

            showMessage(`Removed special characters from ${changeCount} cells`, 'success');
            updateCleaningResults();
        }

        function updateCleaningResults() {
            const sheetName = document.getElementById('cleaningSheet').value;
            if (!sheetName || !processedData[sheetName]) return;

            const data = processedData[sheetName];
            const originalData = workbookData[sheetName];
            
            let html = `
                <div class="result-card">
                    <h4>üßπ Cleaning Results for "${sheetName}"</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>üìä Original Rows</h4>
                            <div class="stat-value">${originalData.length}</div>
                        </div>
                        <div class="stat-card">
                            <h4>üìä Current Rows</h4>
                            <div class="stat-value">${data.length}</div>
                        </div>
                        <div class="stat-card">
                            <h4>üìã Original Columns</h4>
                            <div class="stat-value">${originalData[0] ? originalData[0].length : 0}</div>
                        </div>
                        <div class="stat-card">
                            <h4>üìã Current Columns</h4>
                            <div class="stat-value">${data[0] ? data[0].length : 0}</div>
                        </div>
                    </div>
                    
                    <h5>üìÑ Cleaned Data Preview</h5>
                    ${generateDataPreviewTable(data)}
                </div>
            `;
            
            document.getElementById('cleaningResults').innerHTML = html;
        }

        function generateDataPreviewTable(data) {
            const maxRows = Math.min(data.length, 11);
            
            let html = `
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
            `;
            
            if (data.length > 0) {
                const maxCols = Math.min(data[0].length, 8);
                for (let i = 0; i < maxCols; i++) {
                    html += `<th>${data[0][i] || `Column ${i+1}`}</th>`;
                }
                if (data[0].length > 8) {
                    html += '<th>...</th>';
                }
            }
            
            html += `
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            for (let i = 1; i < maxRows; i++) {
                if (data[i]) {
                    html += '<tr>';
                    const maxCols = Math.min(data[i].length, 8);
                    for (let j = 0; j < maxCols; j++) {
                        html += `<td>${data[i][j] || ''}</td>`;
                    }
                    if (data[i].length > 8) {
                        html += '<td>...</td>';
                    }
                    html += '</tr>';
                }
            }
            
            if (data.length > 11) {
                html += '<tr><td colspan="100%" style="text-align: center; font-style: italic;">... and more rows</td></tr>';
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return html;
        }

        function downloadCleanedData() {
            const sheetName = document.getElementById('cleaningSheet').value;
            if (!sheetName || !processedData[sheetName]) {
                showError('No cleaned data to download. Please perform some cleaning operations first.');
                return;
            }

            const data = processedData[sheetName];
            
            // Convert to Excel format
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, `${sheetName}_cleaned.xlsx`);
            
            showMessage('Cleaned data downloaded successfully!', 'success');
        }

        // Export Functions
        function exportData() {
            const sheetName = document.getElementById('exportSheet').value;
            const format = document.getElementById('exportFormat').value;

            if (!sheetName) {
                showError('Please select a sheet to export');
                return;
            }

            // Use processed data if available, otherwise use original
            const data = processedData[sheetName] || workbookData[sheetName];
            
            if (!data) {
                showError('No data to export');
                return;
            }

            switch (format) {
                case 'excel':
                    exportAsExcel(data, sheetName);
                    break;
                case 'csv':
                    exportAsCSV(data, sheetName);
                    break;
                case 'json':
                    exportAsJSON(data, sheetName);
                    break;
            }
        }

        function exportAsExcel(data, sheetName) {
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, `${sheetName}_export.xlsx`);
            showMessage('Excel file exported successfully!', 'success');
        }

        function exportAsCSV(data, sheetName) {
            const csv = data.map(row => row.map(cell => 
                typeof cell === 'string' && cell.includes(',') ? `"${cell}"` : cell
            ).join(',')).join('\n');
            
            downloadFile(csv, `${sheetName}_export.csv`, 'text/csv');
            showMessage('CSV file exported successfully!', 'success');
        }

        function exportAsJSON(data, sheetName) {
            const headers = data[0];
            const rows = data.slice(1);
            const jsonData = rows.map(row => {
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = row[index];
                });
                return obj;
            });
            
            downloadFile(JSON.stringify(jsonData, null, 2), `${sheetName}_export.json`, 'application/json');
            showMessage('JSON file exported successfully!', 'success');
        }

        // Tab switching function
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Utility functions
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function showError(message) {
            fileInfo.innerHTML = `<div class="error">‚ùå ${message}</div>`;
            fileInfo.style.display = 'block';
            
            setTimeout(() => {
                fileInfo.style.display = 'none';
            }, 5000);
        }

        function showMessage(message, type) {
            const className = type === 'success' ? 'success' : (type === 'warning' ? 'warning' : (type === 'info' ? 'info' : 'error'));
            const icon = type === 'success' ? '‚úÖ' : (type === 'warning' ? '‚ö†Ô∏è' : (type === 'info' ? '‚ÑπÔ∏è' : '‚ùå'));
            
            fileInfo.innerHTML = `<div class="${className}">${icon} ${message}</div>`;
            fileInfo.style.display = 'block';
            
            setTimeout(() => {
                fileInfo.style.display = 'none';
            }, 3000);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Advanced Data Cleaning Tool loaded successfully');
            initializeFileUpload();
        });
    </script>
</body>
</html>
